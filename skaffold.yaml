apiVersion: skaffold/v4beta11
kind: Config
metadata:
  name: leadopt-optimizer
build:
  artifacts:
  - image: leadopt-optimizer-backend
    context: backend/src
    docker:
      dockerfile: Dockerfile
  - image: leadopt-optimizer-frontend
    context: frontend/src
    sync:
      manual:
      - src: 'frontend/src/src/*'
        dest: .
    docker:
      dockerfile: Dockerfile.prod
manifests:
  rawYaml:
  - frontend/k8s/*.yaml
  # - backend/templates/*.yaml
  helm:
    releases:
    - name: mongo
      chartPath: backend/charts/mongo
      valuesFiles:
      - backend/charts/mongo/values.yaml
      wait: true
    - name: postgresql
      chartPath: backend/charts/postgresql
      wait: true
      valuesFiles:
      - backend/charts/postgresql/values.yaml
    - name: django
      chartPath: backend/charts/django
      wait: true
      valuesFiles:
      - backend/charts/django/values.yaml
      # dependsOn:
      # - name: mongodb
      # - name: postgresql
profiles:
- name: mix-deploy
  patches:
  - op: remove
    path: /manifests/helm
  deploy:
    helm:
      releases:
      - name: mongo
        chartPath: backend/charts/mongo
        valuesFiles:
        - backend/charts/mongo/values.yaml
        wait: true
      - name: postgresql
        chartPath: backend/charts/postgresql
        valuesFiles:
        - backend/charts/postgresql/values.yaml
        wait: true
      - name: django
        chartPath: backend/charts/django
        valuesFiles:
        - backend/charts/django/values.yaml
        wait: true
        # dependsOn:
        # - name: mongodb
        # - name: postgresql
